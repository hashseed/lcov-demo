<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - test/benchmarks/data/octane/navier-stokes.js</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">test/benchmarks/data/octane</a> - navier-stokes.js<span style="font-size: 80%;"> (source / <a href="navier-stokes.js.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">412</td>
            <td class="headerCovTableEntry">415</td>
            <td class="headerCovTableEntryHi">99.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-02-14</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">30</td>
            <td class="headerCovTableEntry">37</td>
            <td class="headerCovTableEntryMed">81.1 %</td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span><span class="lineCov">          1 : /**</span></a>
<span class="lineNum">       2 </span><span class="lineCov">          1 :  * Copyright 2013 the V8 project authors. All rights reserved.</span>
<span class="lineNum">       3 </span><span class="lineCov">          1 :  * Copyright 2009 Oliver Hunt &lt;http://nerget.com&gt;</span>
<span class="lineNum">       4 </span><span class="lineCov">          1 :  *</span>
<span class="lineNum">       5 </span><span class="lineCov">          1 :  * Permission is hereby granted, free of charge, to any person</span>
<span class="lineNum">       6 </span><span class="lineCov">          1 :  * obtaining a copy of this software and associated documentation</span>
<span class="lineNum">       7 </span><span class="lineCov">          1 :  * files (the &quot;Software&quot;), to deal in the Software without</span>
<span class="lineNum">       8 </span><span class="lineCov">          1 :  * restriction, including without limitation the rights to use,</span>
<span class="lineNum">       9 </span><span class="lineCov">          1 :  * copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="lineNum">      10 </span><span class="lineCov">          1 :  * copies of the Software, and to permit persons to whom the</span>
<span class="lineNum">      11 </span><span class="lineCov">          1 :  * Software is furnished to do so, subject to the following</span>
<span class="lineNum">      12 </span><span class="lineCov">          1 :  * conditions:</span>
<span class="lineNum">      13 </span><span class="lineCov">          1 :  *</span>
<span class="lineNum">      14 </span><span class="lineCov">          1 :  * The above copyright notice and this permission notice shall be</span>
<span class="lineNum">      15 </span><span class="lineCov">          1 :  * included in all copies or substantial portions of the Software.</span>
<span class="lineNum">      16 </span><span class="lineCov">          1 :  *</span>
<span class="lineNum">      17 </span><span class="lineCov">          1 :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="lineNum">      18 </span><span class="lineCov">          1 :  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES</span>
<span class="lineNum">      19 </span><span class="lineCov">          1 :  * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="lineNum">      20 </span><span class="lineCov">          1 :  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</span>
<span class="lineNum">      21 </span><span class="lineCov">          1 :  * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span>
<span class="lineNum">      22 </span><span class="lineCov">          1 :  * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="lineNum">      23 </span><span class="lineCov">          1 :  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="lineNum">      24 </span><span class="lineCov">          1 :  * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="lineNum">      25 </span><span class="lineCov">          1 :  *</span>
<span class="lineNum">      26 </span><span class="lineCov">          1 :  * Update 10/21/2013: fixed loop variables at line 119</span>
<span class="lineNum">      27 </span><span class="lineCov">          1 :  */</span>
<span class="lineNum">      28 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      29 </span><span class="lineCov">          1 : var NavierStokes = new BenchmarkSuite('NavierStokes', [1484000],</span>
<span class="lineNum">      30 </span><span class="lineCov">          1 :                                       [new Benchmark('NavierStokes',</span>
<span class="lineNum">      31 </span><span class="lineCov">          1 :                                                      true,</span>
<span class="lineNum">      32 </span><span class="lineCov">          1 :                                                      false,</span>
<span class="lineNum">      33 </span><span class="lineCov">          1 :                                                      runNavierStokes,</span>
<span class="lineNum">      34 </span><span class="lineCov">          1 :                                                      setupNavierStokes,</span>
<span class="lineNum">      35 </span><span class="lineCov">          1 :                                                      tearDownNavierStokes,</span>
<span class="lineNum">      36 </span><span class="lineCov">          1 :                                                      null,</span>
<span class="lineNum">      37 </span><span class="lineCov">          1 :                                                      16)]);</span>
<span class="lineNum">      38 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      39 </span><span class="lineCov">          1 : var solver = null;</span>
<a name="40"><span class="lineNum">      40 </span><span class="lineCov">          1 : var nsFrameCounter = 0;</span></a>
<span class="lineNum">      41 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      42 </span><span class="lineCov">         38 : function runNavierStokes()</span>
<span class="lineNum">      43 </span><span class="lineCov">         38 : {</span>
<span class="lineNum">      44 </span><span class="lineCov">         38 :     solver.update();</span>
<span class="lineNum">      45 </span><span class="lineCov">         38 :     nsFrameCounter++;</span>
<span class="lineNum">      46 </span><span class="lineCov">         38 : </span>
<span class="lineNum">      47 </span><span class="lineCov">         38 :     if(nsFrameCounter==15)</span>
<span class="lineNum">      48 </span><span class="lineCov">         38 :         checkResult(solver.getDens());</span>
<a name="49"><span class="lineNum">      49 </span><span class="lineCov">         38 : }</span></a>
<span class="lineNum">      50 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      51 </span><span class="lineCov">          1 : function checkResult(dens) {</span>
<span class="lineNum">      52 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      53 </span><span class="lineCov">          1 :     this.result = 0;</span>
<span class="lineNum">      54 </span><span class="lineCov">          1 :     for (var i=7000;i&lt;7100;i++) {</span>
<span class="lineNum">      55 </span><span class="lineCov">          1 :         this.result+=~~((dens[i]*10));</span>
<span class="lineNum">      56 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">      57 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      58 </span><span class="lineCov">          1 :     if (this.result!=77) {</span>
<span class="lineNum">      59 </span><span class="lineCov">          1 :         throw(new Error(&quot;checksum failed&quot;));</span>
<span class="lineNum">      60 </span><span class="lineCov">          1 :     }</span>
<a name="61"><span class="lineNum">      61 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">      62 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      63 </span><span class="lineCov">          1 : function setupNavierStokes()</span>
<span class="lineNum">      64 </span><span class="lineCov">          1 : {</span>
<span class="lineNum">      65 </span><span class="lineCov">          1 :     solver = new FluidField(null);</span>
<a name="66"><span class="lineNum">      66 </span><span class="lineCov">          1 :     solver.setResolution(128, 128);</span></a>
<span class="lineNum">      67 </span><span class="lineCov">          1 :     solver.setIterations(20);</span>
<span class="lineNum">      68 </span><span class="lineCov">         38 :     solver.setDisplayFunction(function(){});</span>
<span class="lineNum">      69 </span><span class="lineCov">          1 :     solver.setUICallback(prepareFrame);</span>
<span class="lineNum">      70 </span><span class="lineCov">          1 :     solver.reset();</span>
<a name="71"><span class="lineNum">      71 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">      72 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      73 </span><span class="lineCov">          1 : function tearDownNavierStokes()</span>
<span class="lineNum">      74 </span><span class="lineCov">          1 : {</span>
<span class="lineNum">      75 </span><span class="lineCov">          1 :     solver = null;</span>
<a name="76"><span class="lineNum">      76 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">      77 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      78 </span><span class="lineCov">          5 : function addPoints(field) {</span>
<span class="lineNum">      79 </span><span class="lineCov">          5 :     var n = 64;</span>
<span class="lineNum">      80 </span><span class="lineCov">          5 :     for (var i = 1; i &lt;= n; i++) {</span>
<span class="lineNum">      81 </span><span class="lineCov">          5 :         field.setVelocity(i, i, n, n);</span>
<span class="lineNum">      82 </span><span class="lineCov">          5 :         field.setDensity(i, i, 5);</span>
<span class="lineNum">      83 </span><span class="lineCov">          5 :         field.setVelocity(i, n - i, -n, -n);</span>
<span class="lineNum">      84 </span><span class="lineCov">          5 :         field.setDensity(i, n - i, 20);</span>
<span class="lineNum">      85 </span><span class="lineCov">          5 :         field.setVelocity(128 - i, n + i, -n, -n);</span>
<span class="lineNum">      86 </span><span class="lineCov">          5 :         field.setDensity(128 - i, n + i, 30);</span>
<span class="lineNum">      87 </span><span class="lineCov">          5 :     }</span>
<span class="lineNum">      88 </span><span class="lineCov">          5 : }</span>
<span class="lineNum">      89 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      90 </span><span class="lineCov">          1 : var framesTillAddingPoints = 0;</span>
<a name="91"><span class="lineNum">      91 </span><span class="lineCov">          1 : var framesBetweenAddingPoints = 5;</span></a>
<span class="lineNum">      92 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      93 </span><span class="lineCov">         38 : function prepareFrame(field)</span>
<span class="lineNum">      94 </span><span class="lineCov">         38 : {</span>
<span class="lineNum">      95 </span><span class="lineCov">         38 :     if (framesTillAddingPoints == 0) {</span>
<span class="lineNum">      96 </span><span class="lineCov">         38 :         addPoints(field);</span>
<span class="lineNum">      97 </span><span class="lineCov">         38 :         framesTillAddingPoints = framesBetweenAddingPoints;</span>
<span class="lineNum">      98 </span><span class="lineCov">         38 :         framesBetweenAddingPoints++;</span>
<span class="lineNum">      99 </span><span class="lineCov">         38 :     } else {</span>
<span class="lineNum">     100 </span><span class="lineCov">         38 :         framesTillAddingPoints--;</span>
<span class="lineNum">     101 </span><span class="lineCov">         38 :     }</span>
<span class="lineNum">     102 </span><span class="lineCov">         38 : }</span>
<a name="103"><span class="lineNum">     103 </span><span class="lineCov">          1 : </span></a>
<a name="104"><span class="lineNum">     104 </span><span class="lineCov">          1 : // Code from Oliver Hunt (http://nerget.com/fluidSim/pressure.js) starts here.</span></a>
<span class="lineNum">     105 </span><span class="lineCov">          1 : function FluidField(canvas) {</span>
<span class="lineNum">     106 </span><span class="lineCov">        114 :     function addFields(x, s, dt)</span>
<span class="lineNum">     107 </span><span class="lineCov">        114 :     {</span>
<span class="lineNum">     108 </span><span class="lineCov">        114 :         for (var i=0; i&lt;size ; i++ ) x[i] += dt*s[i];</span>
<a name="109"><span class="lineNum">     109 </span><span class="lineCov">        114 :     }</span></a>
<span class="lineNum">     110 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     111 </span><span class="lineCov">       2052 :     function set_bnd(b, x)</span>
<span class="lineNum">     112 </span><span class="lineCov">       2052 :     {</span>
<span class="lineNum">     113 </span><span class="lineCov">       2052 :         if (b===1) {</span>
<span class="lineNum">     114 </span><span class="lineCov">       2052 :             for (var i = 1; i &lt;= width; i++) {</span>
<span class="lineNum">     115 </span><span class="lineCov">       2052 :                 x[i] =  x[i + rowSize];</span>
<span class="lineNum">     116 </span><span class="lineCov">       2052 :                 x[i + (height+1) *rowSize] = x[i + height * rowSize];</span>
<span class="lineNum">     117 </span><span class="lineCov">       2052 :             }</span>
<span class="lineNum">     118 </span><span class="lineCov">       2052 : </span>
<span class="lineNum">     119 </span><span class="lineCov">       2052 :             for (var j = 1; j &lt;= height; j++) {</span>
<span class="lineNum">     120 </span><span class="lineCov">       2052 :                 x[j * rowSize] = -x[1 + j * rowSize];</span>
<span class="lineNum">     121 </span><span class="lineCov">       2052 :                 x[(width + 1) + j * rowSize] = -x[width + j * rowSize];</span>
<span class="lineNum">     122 </span><span class="lineCov">       2052 :             }</span>
<span class="lineNum">     123 </span><span class="lineCov">       2052 :         } else if (b === 2) {</span>
<span class="lineNum">     124 </span><span class="lineCov">       2052 :             for (var i = 1; i &lt;= width; i++) {</span>
<span class="lineNum">     125 </span><span class="lineCov">       2052 :                 x[i] = -x[i + rowSize];</span>
<span class="lineNum">     126 </span><span class="lineCov">       2052 :                 x[i + (height + 1) * rowSize] = -x[i + height * rowSize];</span>
<span class="lineNum">     127 </span><span class="lineCov">       2052 :             }</span>
<span class="lineNum">     128 </span><span class="lineCov">       2052 : </span>
<span class="lineNum">     129 </span><span class="lineCov">       2052 :             for (var j = 1; j &lt;= height; j++) {</span>
<span class="lineNum">     130 </span><span class="lineCov">       2052 :                 x[j * rowSize] =  x[1 + j * rowSize];</span>
<span class="lineNum">     131 </span><span class="lineCov">       2052 :                 x[(width + 1) + j * rowSize] =  x[width + j * rowSize];</span>
<span class="lineNum">     132 </span><span class="lineCov">       2052 :             }</span>
<span class="lineNum">     133 </span><span class="lineCov">       2052 :         } else {</span>
<span class="lineNum">     134 </span><span class="lineCov">       2052 :             for (var i = 1; i &lt;= width; i++) {</span>
<span class="lineNum">     135 </span><span class="lineCov">       2052 :                 x[i] =  x[i + rowSize];</span>
<span class="lineNum">     136 </span><span class="lineCov">       2052 :                 x[i + (height + 1) * rowSize] = x[i + height * rowSize];</span>
<span class="lineNum">     137 </span><span class="lineCov">       2052 :             }</span>
<span class="lineNum">     138 </span><span class="lineCov">       2052 : </span>
<span class="lineNum">     139 </span><span class="lineCov">       2052 :             for (var j = 1; j &lt;= height; j++) {</span>
<span class="lineNum">     140 </span><span class="lineCov">       2052 :                 x[j * rowSize] =  x[1 + j * rowSize];</span>
<span class="lineNum">     141 </span><span class="lineCov">       2052 :                 x[(width + 1) + j * rowSize] =  x[width + j * rowSize];</span>
<span class="lineNum">     142 </span><span class="lineCov">       2052 :             }</span>
<span class="lineNum">     143 </span><span class="lineCov">       2052 :         }</span>
<span class="lineNum">     144 </span><span class="lineCov">       2052 :         var maxEdge = (height + 1) * rowSize;</span>
<span class="lineNum">     145 </span><span class="lineCov">       2052 :         x[0]                 = 0.5 * (x[1] + x[rowSize]);</span>
<span class="lineNum">     146 </span><span class="lineCov">       2052 :         x[maxEdge]           = 0.5 * (x[1 + maxEdge] + x[height * rowSize]);</span>
<span class="lineNum">     147 </span><span class="lineCov">       2052 :         x[(width+1)]         = 0.5 * (x[width] + x[(width + 1) + rowSize]);</span>
<span class="lineNum">     148 </span><span class="lineCov">       2052 :         x[(width+1)+maxEdge] = 0.5 * (x[width + maxEdge] + x[(width + 1) + height * rowSize]);</span>
<a name="149"><span class="lineNum">     149 </span><span class="lineCov">       2052 :     }</span></a>
<span class="lineNum">     150 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     151 </span><span class="lineCov">        114 :     function lin_solve(b, x, x0, a, c)</span>
<span class="lineNum">     152 </span><span class="lineCov">        114 :     {</span>
<span class="lineNum">     153 </span><span class="lineCov">        114 :         if (a === 0 &amp;&amp; c === 1) {</span>
<span class="lineNum">     154 </span><span class="lineCov">        114 :             for (var j=1 ; j&lt;=height; j++) {</span>
<span class="lineNum">     155 </span><span class="lineCov">        114 :                 var currentRow = j * rowSize;</span>
<span class="lineNum">     156 </span><span class="lineCov">        114 :                 ++currentRow;</span>
<span class="lineNum">     157 </span><span class="lineCov">        114 :                 for (var i = 0; i &lt; width; i++) {</span>
<span class="lineNum">     158 </span><span class="lineCov">        114 :                     x[currentRow] = x0[currentRow];</span>
<span class="lineNum">     159 </span><span class="lineCov">        114 :                     ++currentRow;</span>
<span class="lineNum">     160 </span><span class="lineCov">        114 :                 }</span>
<span class="lineNum">     161 </span><span class="lineCov">        114 :             }</span>
<span class="lineNum">     162 </span><span class="lineCov">        114 :             set_bnd(b, x);</span>
<span class="lineNum">     163 </span><span class="lineCov">        114 :         } else {</span>
<span class="lineNum">     164 </span><span class="lineCov">        114 :             var invC = 1 / c;</span>
<span class="lineNum">     165 </span><span class="lineCov">        114 :             for (var k=0 ; k&lt;iterations; k++) {</span>
<span class="lineNum">     166 </span><span class="lineCov">        114 :                 for (var j=1 ; j&lt;=height; j++) {</span>
<span class="lineNum">     167 </span><span class="lineCov">        114 :                     var lastRow = (j - 1) * rowSize;</span>
<span class="lineNum">     168 </span><span class="lineCov">        114 :                     var currentRow = j * rowSize;</span>
<span class="lineNum">     169 </span><span class="lineCov">        114 :                     var nextRow = (j + 1) * rowSize;</span>
<span class="lineNum">     170 </span><span class="lineCov">        114 :                     var lastX = x[currentRow];</span>
<span class="lineNum">     171 </span><span class="lineCov">        114 :                     ++currentRow;</span>
<span class="lineNum">     172 </span><span class="lineCov">        114 :                     for (var i=1; i&lt;=width; i++)</span>
<span class="lineNum">     173 </span><span class="lineCov">        114 :                         lastX = x[currentRow] = (x0[currentRow] + a*(lastX+x[++currentRow]+x[++lastRow]+x[++nextRow])) * invC;</span>
<span class="lineNum">     174 </span><span class="lineCov">        114 :                 }</span>
<span class="lineNum">     175 </span><span class="lineCov">        114 :                 set_bnd(b, x);</span>
<span class="lineNum">     176 </span><span class="lineCov">        114 :             }</span>
<span class="lineNum">     177 </span><span class="lineCov">        114 :         }</span>
<a name="178"><span class="lineNum">     178 </span><span class="lineCov">        114 :     }</span></a>
<span class="lineNum">     179 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     180 </span><span class="lineCov">         38 :     function diffuse(b, x, x0, dt)</span>
<span class="lineNum">     181 </span><span class="lineCov">         38 :     {</span>
<span class="lineNum">     182 </span><span class="lineCov">         38 :         var a = 0;</span>
<span class="lineNum">     183 </span><span class="lineCov">         38 :         lin_solve(b, x, x0, a, 1 + 4*a);</span>
<a name="184"><span class="lineNum">     184 </span><span class="lineCov">         38 :     }</span></a>
<span class="lineNum">     185 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     186 </span><span class="lineCov">         38 :     function lin_solve2(x, x0, y, y0, a, c)</span>
<span class="lineNum">     187 </span><span class="lineCov">         38 :     {</span>
<span class="lineNum">     188 </span><span class="lineCov">         38 :         if (a === 0 &amp;&amp; c === 1) {</span>
<span class="lineNum">     189 </span><span class="lineCov">         38 :             for (var j=1 ; j &lt;= height; j++) {</span>
<span class="lineNum">     190 </span><span class="lineCov">         38 :                 var currentRow = j * rowSize;</span>
<span class="lineNum">     191 </span><span class="lineCov">         38 :                 ++currentRow;</span>
<span class="lineNum">     192 </span><span class="lineCov">         38 :                 for (var i = 0; i &lt; width; i++) {</span>
<span class="lineNum">     193 </span><span class="lineCov">         38 :                     x[currentRow] = x0[currentRow];</span>
<span class="lineNum">     194 </span><span class="lineCov">         38 :                     y[currentRow] = y0[currentRow];</span>
<span class="lineNum">     195 </span><span class="lineCov">         38 :                     ++currentRow;</span>
<span class="lineNum">     196 </span><span class="lineCov">         38 :                 }</span>
<span class="lineNum">     197 </span><span class="lineCov">         38 :             }</span>
<span class="lineNum">     198 </span><span class="lineCov">         38 :             set_bnd(1, x);</span>
<span class="lineNum">     199 </span><span class="lineCov">         38 :             set_bnd(2, y);</span>
<span class="lineNum">     200 </span><span class="lineCov">         38 :         } else {</span>
<span class="lineNum">     201 </span><span class="lineCov">         38 :             var invC = 1/c;</span>
<span class="lineNum">     202 </span><span class="lineCov">         38 :             for (var k=0 ; k&lt;iterations; k++) {</span>
<span class="lineNum">     203 </span><span class="lineCov">         38 :                 for (var j=1 ; j &lt;= height; j++) {</span>
<span class="lineNum">     204 </span><span class="lineCov">         38 :                     var lastRow = (j - 1) * rowSize;</span>
<span class="lineNum">     205 </span><span class="lineCov">         38 :                     var currentRow = j * rowSize;</span>
<span class="lineNum">     206 </span><span class="lineCov">         38 :                     var nextRow = (j + 1) * rowSize;</span>
<span class="lineNum">     207 </span><span class="lineCov">         38 :                     var lastX = x[currentRow];</span>
<span class="lineNum">     208 </span><span class="lineCov">         38 :                     var lastY = y[currentRow];</span>
<span class="lineNum">     209 </span><span class="lineCov">         38 :                     ++currentRow;</span>
<span class="lineNum">     210 </span><span class="lineCov">         38 :                     for (var i = 1; i &lt;= width; i++) {</span>
<span class="lineNum">     211 </span><span class="lineCov">         38 :                         lastX = x[currentRow] = (x0[currentRow] + a * (lastX + x[currentRow] + x[lastRow] + x[nextRow])) * invC;</span>
<span class="lineNum">     212 </span><span class="lineCov">         38 :                         lastY = y[currentRow] = (y0[currentRow] + a * (lastY + y[++currentRow] + y[++lastRow] + y[++nextRow])) * invC;</span>
<span class="lineNum">     213 </span><span class="lineCov">         38 :                     }</span>
<span class="lineNum">     214 </span><span class="lineCov">         38 :                 }</span>
<span class="lineNum">     215 </span><span class="lineCov">         38 :                 set_bnd(1, x);</span>
<span class="lineNum">     216 </span><span class="lineCov">         38 :                 set_bnd(2, y);</span>
<span class="lineNum">     217 </span><span class="lineCov">         38 :             }</span>
<span class="lineNum">     218 </span><span class="lineCov">         38 :         }</span>
<a name="219"><span class="lineNum">     219 </span><span class="lineCov">         38 :     }</span></a>
<span class="lineNum">     220 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     221 </span><span class="lineCov">         38 :     function diffuse2(x, x0, y, y0, dt)</span>
<span class="lineNum">     222 </span><span class="lineCov">         38 :     {</span>
<span class="lineNum">     223 </span><span class="lineCov">         38 :         var a = 0;</span>
<span class="lineNum">     224 </span><span class="lineCov">         38 :         lin_solve2(x, x0, y, y0, a, 1 + 4 * a);</span>
<a name="225"><span class="lineNum">     225 </span><span class="lineCov">         38 :     }</span></a>
<span class="lineNum">     226 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     227 </span><span class="lineCov">        114 :     function advect(b, d, d0, u, v, dt)</span>
<span class="lineNum">     228 </span><span class="lineCov">        114 :     {</span>
<span class="lineNum">     229 </span><span class="lineCov">        114 :         var Wdt0 = dt * width;</span>
<span class="lineNum">     230 </span><span class="lineCov">        114 :         var Hdt0 = dt * height;</span>
<span class="lineNum">     231 </span><span class="lineCov">        114 :         var Wp5 = width + 0.5;</span>
<span class="lineNum">     232 </span><span class="lineCov">        114 :         var Hp5 = height + 0.5;</span>
<span class="lineNum">     233 </span><span class="lineCov">        114 :         for (var j = 1; j&lt;= height; j++) {</span>
<span class="lineNum">     234 </span><span class="lineCov">        114 :             var pos = j * rowSize;</span>
<span class="lineNum">     235 </span><span class="lineCov">        114 :             for (var i = 1; i &lt;= width; i++) {</span>
<span class="lineNum">     236 </span><span class="lineCov">        114 :                 var x = i - Wdt0 * u[++pos];</span>
<span class="lineNum">     237 </span><span class="lineCov">        114 :                 var y = j - Hdt0 * v[pos];</span>
<span class="lineNum">     238 </span><span class="lineCov">        114 :                 if (x &lt; 0.5)</span>
<span class="lineNum">     239 </span><span class="lineCov">        114 :                     x = 0.5;</span>
<span class="lineNum">     240 </span><span class="lineCov">        114 :                 else if (x &gt; Wp5)</span>
<span class="lineNum">     241 </span><span class="lineCov">        114 :                     x = Wp5;</span>
<span class="lineNum">     242 </span><span class="lineCov">        114 :                 var i0 = x | 0;</span>
<span class="lineNum">     243 </span><span class="lineCov">        114 :                 var i1 = i0 + 1;</span>
<span class="lineNum">     244 </span><span class="lineCov">        114 :                 if (y &lt; 0.5)</span>
<span class="lineNum">     245 </span><span class="lineCov">        114 :                     y = 0.5;</span>
<span class="lineNum">     246 </span><span class="lineCov">        114 :                 else if (y &gt; Hp5)</span>
<span class="lineNum">     247 </span><span class="lineCov">        114 :                     y = Hp5;</span>
<span class="lineNum">     248 </span><span class="lineCov">        114 :                 var j0 = y | 0;</span>
<span class="lineNum">     249 </span><span class="lineCov">        114 :                 var j1 = j0 + 1;</span>
<span class="lineNum">     250 </span><span class="lineCov">        114 :                 var s1 = x - i0;</span>
<span class="lineNum">     251 </span><span class="lineCov">        114 :                 var s0 = 1 - s1;</span>
<span class="lineNum">     252 </span><span class="lineCov">        114 :                 var t1 = y - j0;</span>
<span class="lineNum">     253 </span><span class="lineCov">        114 :                 var t0 = 1 - t1;</span>
<span class="lineNum">     254 </span><span class="lineCov">        114 :                 var row1 = j0 * rowSize;</span>
<span class="lineNum">     255 </span><span class="lineCov">        114 :                 var row2 = j1 * rowSize;</span>
<span class="lineNum">     256 </span><span class="lineCov">        114 :                 d[pos] = s0 * (t0 * d0[i0 + row1] + t1 * d0[i0 + row2]) + s1 * (t0 * d0[i1 + row1] + t1 * d0[i1 + row2]);</span>
<span class="lineNum">     257 </span><span class="lineCov">        114 :             }</span>
<span class="lineNum">     258 </span><span class="lineCov">        114 :         }</span>
<span class="lineNum">     259 </span><span class="lineCov">        114 :         set_bnd(b, d);</span>
<a name="260"><span class="lineNum">     260 </span><span class="lineCov">        114 :     }</span></a>
<span class="lineNum">     261 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     262 </span><span class="lineCov">         76 :     function project(u, v, p, div)</span>
<span class="lineNum">     263 </span><span class="lineCov">         76 :     {</span>
<span class="lineNum">     264 </span><span class="lineCov">         76 :         var h = -0.5 / Math.sqrt(width * height);</span>
<span class="lineNum">     265 </span><span class="lineCov">         76 :         for (var j = 1 ; j &lt;= height; j++ ) {</span>
<span class="lineNum">     266 </span><span class="lineCov">         76 :             var row = j * rowSize;</span>
<span class="lineNum">     267 </span><span class="lineCov">         76 :             var previousRow = (j - 1) * rowSize;</span>
<span class="lineNum">     268 </span><span class="lineCov">         76 :             var prevValue = row - 1;</span>
<span class="lineNum">     269 </span><span class="lineCov">         76 :             var currentRow = row;</span>
<span class="lineNum">     270 </span><span class="lineCov">         76 :             var nextValue = row + 1;</span>
<span class="lineNum">     271 </span><span class="lineCov">         76 :             var nextRow = (j + 1) * rowSize;</span>
<span class="lineNum">     272 </span><span class="lineCov">         76 :             for (var i = 1; i &lt;= width; i++ ) {</span>
<span class="lineNum">     273 </span><span class="lineCov">         76 :                 div[++currentRow] = h * (u[++nextValue] - u[++prevValue] + v[++nextRow] - v[++previousRow]);</span>
<span class="lineNum">     274 </span><span class="lineCov">         76 :                 p[currentRow] = 0;</span>
<span class="lineNum">     275 </span><span class="lineCov">         76 :             }</span>
<span class="lineNum">     276 </span><span class="lineCov">         76 :         }</span>
<span class="lineNum">     277 </span><span class="lineCov">         76 :         set_bnd(0, div);</span>
<span class="lineNum">     278 </span><span class="lineCov">         76 :         set_bnd(0, p);</span>
<span class="lineNum">     279 </span><span class="lineCov">         76 : </span>
<span class="lineNum">     280 </span><span class="lineCov">         76 :         lin_solve(0, p, div, 1, 4 );</span>
<span class="lineNum">     281 </span><span class="lineCov">         76 :         var wScale = 0.5 * width;</span>
<span class="lineNum">     282 </span><span class="lineCov">         76 :         var hScale = 0.5 * height;</span>
<span class="lineNum">     283 </span><span class="lineCov">         76 :         for (var j = 1; j&lt;= height; j++ ) {</span>
<span class="lineNum">     284 </span><span class="lineCov">         76 :             var prevPos = j * rowSize - 1;</span>
<span class="lineNum">     285 </span><span class="lineCov">         76 :             var currentPos = j * rowSize;</span>
<span class="lineNum">     286 </span><span class="lineCov">         76 :             var nextPos = j * rowSize + 1;</span>
<span class="lineNum">     287 </span><span class="lineCov">         76 :             var prevRow = (j - 1) * rowSize;</span>
<span class="lineNum">     288 </span><span class="lineCov">         76 :             var currentRow = j * rowSize;</span>
<span class="lineNum">     289 </span><span class="lineCov">         76 :             var nextRow = (j + 1) * rowSize;</span>
<span class="lineNum">     290 </span><span class="lineCov">         76 : </span>
<span class="lineNum">     291 </span><span class="lineCov">         76 :             for (var i = 1; i&lt;= width; i++) {</span>
<span class="lineNum">     292 </span><span class="lineCov">         76 :                 u[++currentPos] -= wScale * (p[++nextPos] - p[++prevPos]);</span>
<span class="lineNum">     293 </span><span class="lineCov">         76 :                 v[currentPos]   -= hScale * (p[++nextRow] - p[++prevRow]);</span>
<span class="lineNum">     294 </span><span class="lineCov">         76 :             }</span>
<span class="lineNum">     295 </span><span class="lineCov">         76 :         }</span>
<span class="lineNum">     296 </span><span class="lineCov">         76 :         set_bnd(1, u);</span>
<span class="lineNum">     297 </span><span class="lineCov">         76 :         set_bnd(2, v);</span>
<a name="298"><span class="lineNum">     298 </span><span class="lineCov">         76 :     }</span></a>
<span class="lineNum">     299 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     300 </span><span class="lineCov">         38 :     function dens_step(x, x0, u, v, dt)</span>
<span class="lineNum">     301 </span><span class="lineCov">         38 :     {</span>
<span class="lineNum">     302 </span><span class="lineCov">         38 :         addFields(x, x0, dt);</span>
<span class="lineNum">     303 </span><span class="lineCov">         38 :         diffuse(0, x0, x, dt );</span>
<span class="lineNum">     304 </span><span class="lineCov">         38 :         advect(0, x, x0, u, v, dt );</span>
<a name="305"><span class="lineNum">     305 </span><span class="lineCov">         38 :     }</span></a>
<span class="lineNum">     306 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     307 </span><span class="lineCov">         38 :     function vel_step(u, v, u0, v0, dt)</span>
<span class="lineNum">     308 </span><span class="lineCov">         38 :     {</span>
<span class="lineNum">     309 </span><span class="lineCov">         38 :         addFields(u, u0, dt );</span>
<span class="lineNum">     310 </span><span class="lineCov">         38 :         addFields(v, v0, dt );</span>
<span class="lineNum">     311 </span><span class="lineCov">         38 :         var temp = u0; u0 = u; u = temp;</span>
<span class="lineNum">     312 </span><span class="lineCov">         38 :         var temp = v0; v0 = v; v = temp;</span>
<span class="lineNum">     313 </span><span class="lineCov">         38 :         diffuse2(u,u0,v,v0, dt);</span>
<span class="lineNum">     314 </span><span class="lineCov">         38 :         project(u, v, u0, v0);</span>
<span class="lineNum">     315 </span><span class="lineCov">         38 :         var temp = u0; u0 = u; u = temp;</span>
<span class="lineNum">     316 </span><span class="lineCov">         38 :         var temp = v0; v0 = v; v = temp;</span>
<span class="lineNum">     317 </span><span class="lineCov">         38 :         advect(1, u, u0, u0, v0, dt);</span>
<span class="lineNum">     318 </span><span class="lineCov">         38 :         advect(2, v, v0, u0, v0, dt);</span>
<a name="319"><span class="lineNum">     319 </span><span class="lineCov">         38 :         project(u, v, u0, v0 );</span></a>
<span class="lineNum">     320 </span><span class="lineCov">         38 :     }</span>
<a name="321"><span class="lineNum">     321 </span><span class="lineCov">          1 :     var uiCallback = function(d,u,v) {};</span></a>
<span class="lineNum">     322 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     323 </span><span class="lineCov">         76 :     function Field(dens, u, v) {</span>
<a name="324"><span class="lineNum">     324 </span><span class="lineCov">         76 :         // Just exposing the fields here rather than using accessors is a measurable win during display (maybe 5%)</span></a>
<span class="lineNum">     325 </span><span class="lineCov">         76 :         // but makes the code ugly.</span>
<span class="lineNum">     326 </span><span class="lineCov">        960 :         this.setDensity = function(x, y, d) {</span>
<a name="327"><span class="lineNum">     327 </span><span class="lineCov">        960 :              dens[(x + 1) + (y + 1) * rowSize] = d;</span></a>
<span class="lineNum">     328 </span><span class="lineCov">        960 :         }</span>
<span class="lineNum">     329 </span><span class="lineCov">         76 :         this.getDensity = function(x, y) {</span>
<a name="330"><span class="lineNum">     330 </span><span class="lineNoCov">          0 :              return dens[(x + 1) + (y + 1) * rowSize];</span></a>
<span class="lineNum">     331 </span><span class="lineCov">         76 :         }</span>
<span class="lineNum">     332 </span><span class="lineCov">        960 :         this.setVelocity = function(x, y, xv, yv) {</span>
<span class="lineNum">     333 </span><span class="lineCov">        960 :              u[(x + 1) + (y + 1) * rowSize] = xv;</span>
<a name="334"><span class="lineNum">     334 </span><span class="lineCov">        960 :              v[(x + 1) + (y + 1) * rowSize] = yv;</span></a>
<span class="lineNum">     335 </span><span class="lineCov">        960 :         }</span>
<span class="lineNum">     336 </span><span class="lineCov">         76 :         this.getXVelocity = function(x, y) {</span>
<a name="337"><span class="lineNum">     337 </span><span class="lineNoCov">          0 :              return u[(x + 1) + (y + 1) * rowSize];</span></a>
<span class="lineNum">     338 </span><span class="lineCov">         76 :         }</span>
<span class="lineNum">     339 </span><span class="lineCov">         76 :         this.getYVelocity = function(x, y) {</span>
<a name="340"><span class="lineNum">     340 </span><span class="lineNoCov">          0 :              return v[(x + 1) + (y + 1) * rowSize];</span></a>
<a name="341"><span class="lineNum">     341 </span><span class="lineCov">         76 :         }</span></a>
<span class="lineNum">     342 </span><span class="lineCov">         76 :         this.width = function() { return width; }</span>
<a name="343"><span class="lineNum">     343 </span><span class="lineCov">         76 :         this.height = function() { return height; }</span></a>
<span class="lineNum">     344 </span><span class="lineCov">         76 :     }</span>
<span class="lineNum">     345 </span><span class="lineCov">         38 :     function queryUI(d, u, v)</span>
<span class="lineNum">     346 </span><span class="lineCov">         38 :     {</span>
<span class="lineNum">     347 </span><span class="lineCov">         38 :         for (var i = 0; i &lt; size; i++)</span>
<span class="lineNum">     348 </span><span class="lineCov">         38 :             u[i] = v[i] = d[i] = 0.0;</span>
<span class="lineNum">     349 </span><span class="lineCov">         38 :         uiCallback(new Field(d, u, v));</span>
<a name="350"><span class="lineNum">     350 </span><span class="lineCov">         38 :     }</span></a>
<span class="lineNum">     351 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     352 </span><span class="lineCov">         38 :     this.update = function () {</span>
<span class="lineNum">     353 </span><span class="lineCov">         38 :         queryUI(dens_prev, u_prev, v_prev);</span>
<span class="lineNum">     354 </span><span class="lineCov">         38 :         vel_step(u, v, u_prev, v_prev, dt);</span>
<span class="lineNum">     355 </span><span class="lineCov">         38 :         dens_step(dens, dens_prev, u, v, dt);</span>
<a name="356"><span class="lineNum">     356 </span><span class="lineCov">         38 :         displayFunc(new Field(dens, u, v));</span></a>
<span class="lineNum">     357 </span><span class="lineCov">         38 :     }</span>
<span class="lineNum">     358 </span><span class="lineCov">          1 :     this.setDisplayFunction = function(func) {</span>
<span class="lineNum">     359 </span><span class="lineCov">          1 :         displayFunc = func;</span>
<a name="360"><span class="lineNum">     360 </span><span class="lineCov">          1 :     }</span></a>
<a name="361"><span class="lineNum">     361 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">     362 </span><span class="lineCov">          1 :     this.iterations = function() { return iterations; }</span>
<span class="lineNum">     363 </span><span class="lineCov">          1 :     this.setIterations = function(iters) {</span>
<span class="lineNum">     364 </span><span class="lineCov">          1 :         if (iters &gt; 0 &amp;&amp; iters &lt;= 100)</span>
<a name="365"><span class="lineNum">     365 </span><span class="lineCov">          1 :            iterations = iters;</span></a>
<span class="lineNum">     366 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     367 </span><span class="lineCov">          1 :     this.setUICallback = function(callback) {</span>
<span class="lineNum">     368 </span><span class="lineCov">          1 :         uiCallback = callback;</span>
<span class="lineNum">     369 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     370 </span><span class="lineCov">          1 :     var iterations = 10;</span>
<span class="lineNum">     371 </span><span class="lineCov">          1 :     var visc = 0.5;</span>
<span class="lineNum">     372 </span><span class="lineCov">          1 :     var dt = 0.1;</span>
<span class="lineNum">     373 </span><span class="lineCov">          1 :     var dens;</span>
<span class="lineNum">     374 </span><span class="lineCov">          1 :     var dens_prev;</span>
<span class="lineNum">     375 </span><span class="lineCov">          1 :     var u;</span>
<span class="lineNum">     376 </span><span class="lineCov">          1 :     var u_prev;</span>
<span class="lineNum">     377 </span><span class="lineCov">          1 :     var v;</span>
<span class="lineNum">     378 </span><span class="lineCov">          1 :     var v_prev;</span>
<span class="lineNum">     379 </span><span class="lineCov">          1 :     var width;</span>
<span class="lineNum">     380 </span><span class="lineCov">          1 :     var height;</span>
<span class="lineNum">     381 </span><span class="lineCov">          1 :     var rowSize;</span>
<a name="382"><span class="lineNum">     382 </span><span class="lineCov">          1 :     var size;</span></a>
<span class="lineNum">     383 </span><span class="lineCov">          1 :     var displayFunc;</span>
<span class="lineNum">     384 </span><span class="lineCov">          3 :     function reset()</span>
<span class="lineNum">     385 </span><span class="lineCov">          3 :     {</span>
<span class="lineNum">     386 </span><span class="lineCov">          3 :         rowSize = width + 2;</span>
<span class="lineNum">     387 </span><span class="lineCov">          3 :         size = (width+2)*(height+2);</span>
<span class="lineNum">     388 </span><span class="lineCov">          3 :         dens = new Array(size);</span>
<span class="lineNum">     389 </span><span class="lineCov">          3 :         dens_prev = new Array(size);</span>
<span class="lineNum">     390 </span><span class="lineCov">          3 :         u = new Array(size);</span>
<span class="lineNum">     391 </span><span class="lineCov">          3 :         u_prev = new Array(size);</span>
<span class="lineNum">     392 </span><span class="lineCov">          3 :         v = new Array(size);</span>
<span class="lineNum">     393 </span><span class="lineCov">          3 :         v_prev = new Array(size);</span>
<span class="lineNum">     394 </span><span class="lineCov">          3 :         for (var i = 0; i &lt; size; i++)</span>
<span class="lineNum">     395 </span><span class="lineCov">          3 :             dens_prev[i] = u_prev[i] = v_prev[i] = dens[i] = u[i] = v[i] = 0;</span>
<a name="396"><span class="lineNum">     396 </span><span class="lineCov">          3 :     }</span></a>
<span class="lineNum">     397 </span><span class="lineCov">          1 :     this.reset = reset;</span>
<span class="lineNum">     398 </span><span class="lineCov">          1 :     this.getDens = function()</span>
<span class="lineNum">     399 </span><span class="lineCov">          1 :     {</span>
<a name="400"><span class="lineNum">     400 </span><span class="lineCov">          1 :         return dens;</span></a>
<span class="lineNum">     401 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     402 </span><span class="lineCov">          2 :     this.setResolution = function (hRes, wRes)</span>
<span class="lineNum">     403 </span><span class="lineCov">          2 :     {</span>
<span class="lineNum">     404 </span><span class="lineCov">          2 :         var res = wRes * hRes;</span>
<span class="lineNum">     405 </span><span class="lineCov">          2 :         if (res &gt; 0 &amp;&amp; res &lt; 1000000 &amp;&amp; (wRes != width || hRes != height)) {</span>
<span class="lineNum">     406 </span><span class="lineCov">          2 :             width = wRes;</span>
<span class="lineNum">     407 </span><span class="lineCov">          2 :             height = hRes;</span>
<span class="lineNum">     408 </span><span class="lineCov">          2 :             reset();</span>
<span class="lineNum">     409 </span><span class="lineCov">          2 :             return true;</span>
<span class="lineNum">     410 </span><span class="lineCov">          2 :         }</span>
<span class="lineNum">     411 </span><span class="lineCov">          2 :         return false;</span>
<span class="lineNum">     412 </span><span class="lineCov">          2 :     }</span>
<span class="lineNum">     413 </span><span class="lineCov">          1 :     this.setResolution(64, 64);</span>
<span class="lineNum">     414 </span><span class="lineCov">          1 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
