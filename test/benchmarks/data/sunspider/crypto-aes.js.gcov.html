<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - test/benchmarks/data/sunspider/crypto-aes.js</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">test/benchmarks/data/sunspider</a> - crypto-aes.js<span style="font-size: 80%;"> (source / <a href="crypto-aes.js.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">353</td>
            <td class="headerCovTableEntry">427</td>
            <td class="headerCovTableEntryMed">82.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-02-14</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">15</td>
            <td class="headerCovTableEntry">20</td>
            <td class="headerCovTableEntryMed">75.0 %</td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span><span class="lineCov">          1 : /* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span></a>
<span class="lineNum">       2 </span><span class="lineCov">          1 : </span>
<span class="lineNum">       3 </span><span class="lineCov">          1 : /*</span>
<span class="lineNum">       4 </span><span class="lineCov">          1 :  * AES Cipher function: encrypt 'input' with Rijndael algorithm</span>
<span class="lineNum">       5 </span><span class="lineCov">          1 :  *</span>
<span class="lineNum">       6 </span><span class="lineCov">          1 :  *   takes   byte-array 'input' (16 bytes)</span>
<span class="lineNum">       7 </span><span class="lineCov">          1 :  *           2D byte-array key schedule 'w' (Nr+1 x Nb bytes)</span>
<span class="lineNum">       8 </span><span class="lineCov">          1 :  *</span>
<span class="lineNum">       9 </span><span class="lineCov">          1 :  *   applies Nr rounds (10/12/14) using key schedule w for 'add round key' stage</span>
<span class="lineNum">      10 </span><span class="lineCov">          1 :  *</span>
<a name="11"><span class="lineNum">      11 </span><span class="lineCov">          1 :  *   returns byte-array encrypted value (16 bytes)</span></a>
<span class="lineNum">      12 </span><span class="lineCov">          1 :  */</span>
<span class="lineNum">      13 </span><span class="lineCov">        170 : function Cipher(input, w) {    // main Cipher function [§5.1]</span>
<span class="lineNum">      14 </span><span class="lineCov">        170 :   var Nb = 4;               // block size (in words): no of columns in state (fixed at 4 for AES)</span>
<span class="lineNum">      15 </span><span class="lineCov">        170 :   var Nr = w.length/Nb - 1; // no of rounds: 10/12/14 for 128/192/256-bit keys</span>
<span class="lineNum">      16 </span><span class="lineCov">        170 : </span>
<span class="lineNum">      17 </span><span class="lineCov">        170 :   var state = [[],[],[],[]];  // initialise 4xNb byte-array 'state' with input [§3.4]</span>
<span class="lineNum">      18 </span><span class="lineCov">        170 :   for (var i=0; i&lt;4*Nb; i++) state[i%4][Math.floor(i/4)] = input[i];</span>
<span class="lineNum">      19 </span><span class="lineCov">        170 : </span>
<span class="lineNum">      20 </span><span class="lineCov">        170 :   state = AddRoundKey(state, w, 0, Nb);</span>
<span class="lineNum">      21 </span><span class="lineCov">        170 : </span>
<span class="lineNum">      22 </span><span class="lineCov">        170 :   for (var round=1; round&lt;Nr; round++) {</span>
<span class="lineNum">      23 </span><span class="lineCov">        170 :     state = SubBytes(state, Nb);</span>
<span class="lineNum">      24 </span><span class="lineCov">        170 :     state = ShiftRows(state, Nb);</span>
<span class="lineNum">      25 </span><span class="lineCov">        170 :     state = MixColumns(state, Nb);</span>
<span class="lineNum">      26 </span><span class="lineCov">        170 :     state = AddRoundKey(state, w, round, Nb);</span>
<span class="lineNum">      27 </span><span class="lineCov">        170 :   }</span>
<span class="lineNum">      28 </span><span class="lineCov">        170 : </span>
<span class="lineNum">      29 </span><span class="lineCov">        170 :   state = SubBytes(state, Nb);</span>
<span class="lineNum">      30 </span><span class="lineCov">        170 :   state = ShiftRows(state, Nb);</span>
<span class="lineNum">      31 </span><span class="lineCov">        170 :   state = AddRoundKey(state, w, Nr, Nb);</span>
<span class="lineNum">      32 </span><span class="lineCov">        170 : </span>
<span class="lineNum">      33 </span><span class="lineCov">        170 :   var output = new Array(4*Nb);  // convert state to 1-d array before returning [§3.4]</span>
<span class="lineNum">      34 </span><span class="lineCov">        170 :   for (var i=0; i&lt;4*Nb; i++) output[i] = state[i%4][Math.floor(i/4)];</span>
<span class="lineNum">      35 </span><span class="lineCov">        170 :   return output;</span>
<span class="lineNum">      36 </span><span class="lineCov">        170 : }</span>
<a name="37"><span class="lineNum">      37 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">      38 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      39 </span><span class="lineCov">       2380 : function SubBytes(s, Nb) {    // apply SBox to state S [§5.1.1]</span>
<span class="lineNum">      40 </span><span class="lineCov">       2380 :   for (var r=0; r&lt;4; r++) {</span>
<span class="lineNum">      41 </span><span class="lineCov">       2380 :     for (var c=0; c&lt;Nb; c++) s[r][c] = Sbox[s[r][c]];</span>
<span class="lineNum">      42 </span><span class="lineCov">       2380 :   }</span>
<span class="lineNum">      43 </span><span class="lineCov">       2380 :   return s;</span>
<span class="lineNum">      44 </span><span class="lineCov">       2380 : }</span>
<a name="45"><span class="lineNum">      45 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">      46 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      47 </span><span class="lineCov">       2380 : function ShiftRows(s, Nb) {    // shift row r of state S left by r bytes [§5.1.2]</span>
<span class="lineNum">      48 </span><span class="lineCov">       2380 :   var t = new Array(4);</span>
<span class="lineNum">      49 </span><span class="lineCov">       2380 :   for (var r=1; r&lt;4; r++) {</span>
<span class="lineNum">      50 </span><span class="lineCov">       2380 :     for (var c=0; c&lt;4; c++) t[c] = s[r][(c+r)%Nb];  // shift into temp copy</span>
<span class="lineNum">      51 </span><span class="lineCov">       2380 :     for (var c=0; c&lt;4; c++) s[r][c] = t[c];         // and copy back</span>
<span class="lineNum">      52 </span><span class="lineCov">       2380 :   }          // note that this will work for Nb=4,5,6, but not 7,8 (always 4 for AES):</span>
<span class="lineNum">      53 </span><span class="lineCov">       2380 :   return s;  // see fp.gladman.plus.com/cryptography_technology/rijndael/aes.spec.311.pdf </span>
<span class="lineNum">      54 </span><span class="lineCov">       2380 : }</span>
<a name="55"><span class="lineNum">      55 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">      56 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      57 </span><span class="lineCov">       2210 : function MixColumns(s, Nb) {   // combine bytes of each col of state S [§5.1.3]</span>
<span class="lineNum">      58 </span><span class="lineCov">       2210 :   for (var c=0; c&lt;4; c++) {</span>
<span class="lineNum">      59 </span><span class="lineCov">       2210 :     var a = new Array(4);  // 'a' is a copy of the current column from 's'</span>
<span class="lineNum">      60 </span><span class="lineCov">       2210 :     var b = new Array(4);  // 'b' is a•{02} in GF(2^8)</span>
<span class="lineNum">      61 </span><span class="lineCov">       2210 :     for (var i=0; i&lt;4; i++) {</span>
<span class="lineNum">      62 </span><span class="lineCov">       2210 :       a[i] = s[i][c];</span>
<span class="lineNum">      63 </span><span class="lineCov">       2210 :       b[i] = s[i][c]&amp;0x80 ? s[i][c]&lt;&lt;1 ^ 0x011b : s[i][c]&lt;&lt;1;</span>
<span class="lineNum">      64 </span><span class="lineCov">       2210 :     }</span>
<span class="lineNum">      65 </span><span class="lineCov">       2210 :     // a[n] ^ b[n] is a•{03} in GF(2^8)</span>
<span class="lineNum">      66 </span><span class="lineCov">       2210 :     s[0][c] = b[0] ^ a[1] ^ b[1] ^ a[2] ^ a[3]; // 2*a0 + 3*a1 + a2 + a3</span>
<span class="lineNum">      67 </span><span class="lineCov">       2210 :     s[1][c] = a[0] ^ b[1] ^ a[2] ^ b[2] ^ a[3]; // a0 * 2*a1 + 3*a2 + a3</span>
<span class="lineNum">      68 </span><span class="lineCov">       2210 :     s[2][c] = a[0] ^ a[1] ^ b[2] ^ a[3] ^ b[3]; // a0 + a1 + 2*a2 + 3*a3</span>
<span class="lineNum">      69 </span><span class="lineCov">       2210 :     s[3][c] = a[0] ^ b[0] ^ a[1] ^ a[2] ^ b[3]; // 3*a0 + a1 + a2 + 2*a3</span>
<span class="lineNum">      70 </span><span class="lineCov">       2210 :   }</span>
<span class="lineNum">      71 </span><span class="lineCov">       2210 :   return s;</span>
<span class="lineNum">      72 </span><span class="lineCov">       2210 : }</span>
<a name="73"><span class="lineNum">      73 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">      74 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      75 </span><span class="lineCov">       2550 : function AddRoundKey(state, w, rnd, Nb) {  // xor Round Key into state S [§5.1.4]</span>
<span class="lineNum">      76 </span><span class="lineCov">       2550 :   for (var r=0; r&lt;4; r++) {</span>
<span class="lineNum">      77 </span><span class="lineCov">       2550 :     for (var c=0; c&lt;Nb; c++) state[r][c] ^= w[rnd*4+c][r];</span>
<span class="lineNum">      78 </span><span class="lineCov">       2550 :   }</span>
<span class="lineNum">      79 </span><span class="lineCov">       2550 :   return state;</span>
<span class="lineNum">      80 </span><span class="lineCov">       2550 : }</span>
<a name="81"><span class="lineNum">      81 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">      82 </span><span class="lineCov">          1 : </span>
<span class="lineNum">      83 </span><span class="lineCov">          4 : function KeyExpansion(key) {  // generate Key Schedule (byte-array Nr+1 x Nb) from Key [§5.2]</span>
<span class="lineNum">      84 </span><span class="lineCov">          4 :   var Nb = 4;            // block size (in words): no of columns in state (fixed at 4 for AES)</span>
<span class="lineNum">      85 </span><span class="lineCov">          4 :   var Nk = key.length/4  // key length (in words): 4/6/8 for 128/192/256-bit keys</span>
<span class="lineNum">      86 </span><span class="lineCov">          4 :   var Nr = Nk + 6;       // no of rounds: 10/12/14 for 128/192/256-bit keys</span>
<span class="lineNum">      87 </span><span class="lineCov">          4 : </span>
<span class="lineNum">      88 </span><span class="lineCov">          4 :   var w = new Array(Nb*(Nr+1));</span>
<span class="lineNum">      89 </span><span class="lineCov">          4 :   var temp = new Array(4);</span>
<span class="lineNum">      90 </span><span class="lineCov">          4 : </span>
<span class="lineNum">      91 </span><span class="lineCov">          4 :   for (var i=0; i&lt;Nk; i++) {</span>
<span class="lineNum">      92 </span><span class="lineCov">          4 :     var r = [key[4*i], key[4*i+1], key[4*i+2], key[4*i+3]];</span>
<span class="lineNum">      93 </span><span class="lineCov">          4 :     w[i] = r;</span>
<span class="lineNum">      94 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">      95 </span><span class="lineCov">          4 : </span>
<span class="lineNum">      96 </span><span class="lineCov">          4 :   for (var i=Nk; i&lt;(Nb*(Nr+1)); i++) {</span>
<span class="lineNum">      97 </span><span class="lineCov">          4 :     w[i] = new Array(4);</span>
<span class="lineNum">      98 </span><span class="lineCov">          4 :     for (var t=0; t&lt;4; t++) temp[t] = w[i-1][t];</span>
<span class="lineNum">      99 </span><span class="lineCov">          4 :     if (i % Nk == 0) {</span>
<span class="lineNum">     100 </span><span class="lineCov">          4 :       temp = SubWord(RotWord(temp));</span>
<span class="lineNum">     101 </span><span class="lineCov">          4 :       for (var t=0; t&lt;4; t++) temp[t] ^= Rcon[i/Nk][t];</span>
<span class="lineNum">     102 </span><span class="lineCov">          4 :     } else if (Nk &gt; 6 &amp;&amp; i%Nk == 4) {</span>
<span class="lineNum">     103 </span><span class="lineCov">          4 :       temp = SubWord(temp);</span>
<span class="lineNum">     104 </span><span class="lineCov">          4 :     }</span>
<span class="lineNum">     105 </span><span class="lineCov">          4 :     for (var t=0; t&lt;4; t++) w[i][t] = w[i-Nk][t] ^ temp[t];</span>
<span class="lineNum">     106 </span><span class="lineCov">          4 :   }</span>
<span class="lineNum">     107 </span><span class="lineCov">          4 : </span>
<span class="lineNum">     108 </span><span class="lineCov">          4 :   return w;</span>
<a name="109"><span class="lineNum">     109 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">     110 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     111 </span><span class="lineCov">         52 : function SubWord(w) {    // apply SBox to 4-byte word w</span>
<span class="lineNum">     112 </span><span class="lineCov">         52 :   for (var i=0; i&lt;4; i++) w[i] = Sbox[w[i]];</span>
<span class="lineNum">     113 </span><span class="lineCov">         52 :   return w;</span>
<a name="114"><span class="lineNum">     114 </span><span class="lineCov">         52 : }</span></a>
<span class="lineNum">     115 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     116 </span><span class="lineCov">         28 : function RotWord(w) {    // rotate 4-byte word w left by one byte</span>
<span class="lineNum">     117 </span><span class="lineCov">         28 :   w[4] = w[0];</span>
<span class="lineNum">     118 </span><span class="lineCov">         28 :   for (var i=0; i&lt;4; i++) w[i] = w[i+1];</span>
<span class="lineNum">     119 </span><span class="lineCov">         28 :   return w;</span>
<span class="lineNum">     120 </span><span class="lineCov">         28 : }</span>
<span class="lineNum">     121 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     122 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     123 </span><span class="lineCov">          1 : // Sbox is pre-computed multiplicative inverse in GF(2^8) used in SubBytes and KeyExpansion [§5.1.1]</span>
<span class="lineNum">     124 </span><span class="lineCov">          1 : var Sbox =  [0x63,0x7c,0x77,0x7b,0xf2,0x6b,0x6f,0xc5,0x30,0x01,0x67,0x2b,0xfe,0xd7,0xab,0x76,</span>
<span class="lineNum">     125 </span><span class="lineCov">          1 :              0xca,0x82,0xc9,0x7d,0xfa,0x59,0x47,0xf0,0xad,0xd4,0xa2,0xaf,0x9c,0xa4,0x72,0xc0,</span>
<span class="lineNum">     126 </span><span class="lineCov">          1 :              0xb7,0xfd,0x93,0x26,0x36,0x3f,0xf7,0xcc,0x34,0xa5,0xe5,0xf1,0x71,0xd8,0x31,0x15,</span>
<span class="lineNum">     127 </span><span class="lineCov">          1 :              0x04,0xc7,0x23,0xc3,0x18,0x96,0x05,0x9a,0x07,0x12,0x80,0xe2,0xeb,0x27,0xb2,0x75,</span>
<span class="lineNum">     128 </span><span class="lineCov">          1 :              0x09,0x83,0x2c,0x1a,0x1b,0x6e,0x5a,0xa0,0x52,0x3b,0xd6,0xb3,0x29,0xe3,0x2f,0x84,</span>
<span class="lineNum">     129 </span><span class="lineCov">          1 :              0x53,0xd1,0x00,0xed,0x20,0xfc,0xb1,0x5b,0x6a,0xcb,0xbe,0x39,0x4a,0x4c,0x58,0xcf,</span>
<span class="lineNum">     130 </span><span class="lineCov">          1 :              0xd0,0xef,0xaa,0xfb,0x43,0x4d,0x33,0x85,0x45,0xf9,0x02,0x7f,0x50,0x3c,0x9f,0xa8,</span>
<span class="lineNum">     131 </span><span class="lineCov">          1 :              0x51,0xa3,0x40,0x8f,0x92,0x9d,0x38,0xf5,0xbc,0xb6,0xda,0x21,0x10,0xff,0xf3,0xd2,</span>
<span class="lineNum">     132 </span><span class="lineCov">          1 :              0xcd,0x0c,0x13,0xec,0x5f,0x97,0x44,0x17,0xc4,0xa7,0x7e,0x3d,0x64,0x5d,0x19,0x73,</span>
<span class="lineNum">     133 </span><span class="lineCov">          1 :              0x60,0x81,0x4f,0xdc,0x22,0x2a,0x90,0x88,0x46,0xee,0xb8,0x14,0xde,0x5e,0x0b,0xdb,</span>
<span class="lineNum">     134 </span><span class="lineCov">          1 :              0xe0,0x32,0x3a,0x0a,0x49,0x06,0x24,0x5c,0xc2,0xd3,0xac,0x62,0x91,0x95,0xe4,0x79,</span>
<span class="lineNum">     135 </span><span class="lineCov">          1 :              0xe7,0xc8,0x37,0x6d,0x8d,0xd5,0x4e,0xa9,0x6c,0x56,0xf4,0xea,0x65,0x7a,0xae,0x08,</span>
<span class="lineNum">     136 </span><span class="lineCov">          1 :              0xba,0x78,0x25,0x2e,0x1c,0xa6,0xb4,0xc6,0xe8,0xdd,0x74,0x1f,0x4b,0xbd,0x8b,0x8a,</span>
<span class="lineNum">     137 </span><span class="lineCov">          1 :              0x70,0x3e,0xb5,0x66,0x48,0x03,0xf6,0x0e,0x61,0x35,0x57,0xb9,0x86,0xc1,0x1d,0x9e,</span>
<span class="lineNum">     138 </span><span class="lineCov">          1 :              0xe1,0xf8,0x98,0x11,0x69,0xd9,0x8e,0x94,0x9b,0x1e,0x87,0xe9,0xce,0x55,0x28,0xdf,</span>
<span class="lineNum">     139 </span><span class="lineCov">          1 :              0x8c,0xa1,0x89,0x0d,0xbf,0xe6,0x42,0x68,0x41,0x99,0x2d,0x0f,0xb0,0x54,0xbb,0x16];</span>
<span class="lineNum">     140 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     141 </span><span class="lineCov">          1 : // Rcon is Round Constant used for the Key Expansion [1st col is 2^(r-1) in GF(2^8)] [§5.2]</span>
<span class="lineNum">     142 </span><span class="lineCov">          1 : var Rcon = [ [0x00, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     143 </span><span class="lineCov">          1 :              [0x01, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     144 </span><span class="lineCov">          1 :              [0x02, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     145 </span><span class="lineCov">          1 :              [0x04, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     146 </span><span class="lineCov">          1 :              [0x08, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     147 </span><span class="lineCov">          1 :              [0x10, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     148 </span><span class="lineCov">          1 :              [0x20, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :              [0x40, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     150 </span><span class="lineCov">          1 :              [0x80, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     151 </span><span class="lineCov">          1 :              [0x1b, 0x00, 0x00, 0x00],</span>
<span class="lineNum">     152 </span><span class="lineCov">          1 :              [0x36, 0x00, 0x00, 0x00] ]; </span>
<span class="lineNum">     153 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     154 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     155 </span><span class="lineCov">          1 : /* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span>
<span class="lineNum">     156 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     157 </span><span class="lineCov">          1 : /* </span>
<span class="lineNum">     158 </span><span class="lineCov">          1 :  * Use AES to encrypt 'plaintext' with 'password' using 'nBits' key, in 'Counter' mode of operation</span>
<span class="lineNum">     159 </span><span class="lineCov">          1 :  *                           - see http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf</span>
<span class="lineNum">     160 </span><span class="lineCov">          1 :  *   for each block</span>
<span class="lineNum">     161 </span><span class="lineCov">          1 :  *   - outputblock = cipher(counter, key)</span>
<a name="162"><span class="lineNum">     162 </span><span class="lineCov">          1 :  *   - cipherblock = plaintext xor outputblock</span></a>
<span class="lineNum">     163 </span><span class="lineCov">          1 :  */</span>
<span class="lineNum">     164 </span><span class="lineCov">          1 : function AESEncryptCtr(plaintext, password, nBits) {</span>
<span class="lineNum">     165 </span><span class="lineCov">          1 :   if (!(nBits==128 || nBits==192 || nBits==256)) return '';  // standard allows 128/192/256 bit keys</span>
<span class="lineNum">     166 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     167 </span><span class="lineCov">          1 :   // for this example script, generate the key by applying Cipher to 1st 16/24/32 chars of password; </span>
<span class="lineNum">     168 </span><span class="lineCov">          1 :   // for real-world applications, a more secure approach would be to hash the password e.g. with SHA-1</span>
<span class="lineNum">     169 </span><span class="lineCov">          1 :   var nBytes = nBits/8;  // no bytes in key</span>
<span class="lineNum">     170 </span><span class="lineCov">          1 :   var pwBytes = new Array(nBytes);</span>
<span class="lineNum">     171 </span><span class="lineCov">          1 :   for (var i=0; i&lt;nBytes; i++) pwBytes[i] = password.charCodeAt(i) &amp; 0xff;</span>
<span class="lineNum">     172 </span><span class="lineCov">          1 :   var key = Cipher(pwBytes, KeyExpansion(pwBytes));</span>
<span class="lineNum">     173 </span><span class="lineCov">          1 :   key = key.concat(key.slice(0, nBytes-16));  // key is now 16/24/32 bytes long</span>
<span class="lineNum">     174 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     175 </span><span class="lineCov">          1 :   // initialise counter block (NIST SP800-38A §B.2): millisecond time-stamp for nonce in 1st 8 bytes,</span>
<span class="lineNum">     176 </span><span class="lineCov">          1 :   // block counter in 2nd 8 bytes</span>
<span class="lineNum">     177 </span><span class="lineCov">          1 :   var blockSize = 16;  // block size fixed at 16 bytes / 128 bits (Nb=4) for AES</span>
<span class="lineNum">     178 </span><span class="lineCov">          1 :   var counterBlock = new Array(blockSize);  // block size fixed at 16 bytes / 128 bits (Nb=4) for AES</span>
<span class="lineNum">     179 </span><span class="lineCov">          1 :   var nonce = (new Date()).getTime();  // milliseconds since 1-Jan-1970</span>
<span class="lineNum">     180 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     181 </span><span class="lineCov">          1 :   // encode nonce in two stages to cater for JavaScript 32-bit limit on bitwise ops</span>
<span class="lineNum">     182 </span><span class="lineCov">          1 :   for (var i=0; i&lt;4; i++) counterBlock[i] = (nonce &gt;&gt;&gt; i*8) &amp; 0xff;</span>
<span class="lineNum">     183 </span><span class="lineCov">          1 :   for (var i=0; i&lt;4; i++) counterBlock[i+4] = (nonce/0x100000000 &gt;&gt;&gt; i*8) &amp; 0xff; </span>
<span class="lineNum">     184 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     185 </span><span class="lineCov">          1 :   // generate key schedule - an expansion of the key into distinct Key Rounds for each round</span>
<span class="lineNum">     186 </span><span class="lineCov">          1 :   var keySchedule = KeyExpansion(key);</span>
<span class="lineNum">     187 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     188 </span><span class="lineCov">          1 :   var blockCount = Math.ceil(plaintext.length/blockSize);</span>
<span class="lineNum">     189 </span><span class="lineCov">          1 :   var ciphertext = new Array(blockCount);  // ciphertext as array of strings</span>
<span class="lineNum">     190 </span><span class="lineCov">          1 :   </span>
<span class="lineNum">     191 </span><span class="lineCov">          1 :   for (var b=0; b&lt;blockCount; b++) {</span>
<span class="lineNum">     192 </span><span class="lineCov">          1 :     // set counter (block #) in last 8 bytes of counter block (leaving nonce in 1st 8 bytes)</span>
<span class="lineNum">     193 </span><span class="lineCov">          1 :     // again done in two stages for 32-bit ops</span>
<span class="lineNum">     194 </span><span class="lineCov">          1 :     for (var c=0; c&lt;4; c++) counterBlock[15-c] = (b &gt;&gt;&gt; c*8) &amp; 0xff;</span>
<span class="lineNum">     195 </span><span class="lineCov">          1 :     for (var c=0; c&lt;4; c++) counterBlock[15-c-4] = (b/0x100000000 &gt;&gt;&gt; c*8)</span>
<span class="lineNum">     196 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     197 </span><span class="lineCov">          1 :     var cipherCntr = Cipher(counterBlock, keySchedule);  // -- encrypt counter block --</span>
<span class="lineNum">     198 </span><span class="lineCov">          1 :     </span>
<span class="lineNum">     199 </span><span class="lineCov">          1 :     // calculate length of final block:</span>
<span class="lineNum">     200 </span><span class="lineCov">          1 :     var blockLength = b&lt;blockCount-1 ? blockSize : (plaintext.length-1)%blockSize+1;</span>
<span class="lineNum">     201 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     202 </span><span class="lineCov">          1 :     var ct = '';</span>
<span class="lineNum">     203 </span><span class="lineCov">          1 :     for (var i=0; i&lt;blockLength; i++) {  // -- xor plaintext with ciphered counter byte-by-byte --</span>
<span class="lineNum">     204 </span><span class="lineCov">          1 :       var plaintextByte = plaintext.charCodeAt(b*blockSize+i);</span>
<span class="lineNum">     205 </span><span class="lineCov">          1 :       var cipherByte = plaintextByte ^ cipherCntr[i];</span>
<span class="lineNum">     206 </span><span class="lineCov">          1 :       ct += String.fromCharCode(cipherByte);</span>
<span class="lineNum">     207 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     208 </span><span class="lineCov">          1 :     // ct is now ciphertext for this block</span>
<span class="lineNum">     209 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     210 </span><span class="lineCov">          1 :     ciphertext[b] = escCtrlChars(ct);  // escape troublesome characters in ciphertext</span>
<span class="lineNum">     211 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     212 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     213 </span><span class="lineCov">          1 :   // convert the nonce to a string to go on the front of the ciphertext</span>
<span class="lineNum">     214 </span><span class="lineCov">          1 :   var ctrTxt = '';</span>
<span class="lineNum">     215 </span><span class="lineCov">          1 :   for (var i=0; i&lt;8; i++) ctrTxt += String.fromCharCode(counterBlock[i]);</span>
<span class="lineNum">     216 </span><span class="lineCov">          1 :   ctrTxt = escCtrlChars(ctrTxt);</span>
<span class="lineNum">     217 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     218 </span><span class="lineCov">          1 :   // use '-' to separate blocks, use Array.join to concatenate arrays of strings for efficiency</span>
<span class="lineNum">     219 </span><span class="lineCov">          1 :   return ctrTxt + '-' + ciphertext.join('-');</span>
<span class="lineNum">     220 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     221 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     222 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     223 </span><span class="lineCov">          1 : /* </span>
<span class="lineNum">     224 </span><span class="lineCov">          1 :  * Use AES to decrypt 'ciphertext' with 'password' using 'nBits' key, in Counter mode of operation</span>
<span class="lineNum">     225 </span><span class="lineCov">          1 :  *</span>
<span class="lineNum">     226 </span><span class="lineCov">          1 :  *   for each block</span>
<span class="lineNum">     227 </span><span class="lineCov">          1 :  *   - outputblock = cipher(counter, key)</span>
<a name="228"><span class="lineNum">     228 </span><span class="lineCov">          1 :  *   - cipherblock = plaintext xor outputblock</span></a>
<span class="lineNum">     229 </span><span class="lineCov">          1 :  */</span>
<span class="lineNum">     230 </span><span class="lineCov">          1 : function AESDecryptCtr(ciphertext, password, nBits) {</span>
<span class="lineNum">     231 </span><span class="lineCov">          1 :   if (!(nBits==128 || nBits==192 || nBits==256)) return '';  // standard allows 128/192/256 bit keys</span>
<span class="lineNum">     232 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     233 </span><span class="lineCov">          1 :   var nBytes = nBits/8;  // no bytes in key</span>
<span class="lineNum">     234 </span><span class="lineCov">          1 :   var pwBytes = new Array(nBytes);</span>
<span class="lineNum">     235 </span><span class="lineCov">          1 :   for (var i=0; i&lt;nBytes; i++) pwBytes[i] = password.charCodeAt(i) &amp; 0xff;</span>
<span class="lineNum">     236 </span><span class="lineCov">          1 :   var pwKeySchedule = KeyExpansion(pwBytes);</span>
<span class="lineNum">     237 </span><span class="lineCov">          1 :   var key = Cipher(pwBytes, pwKeySchedule);</span>
<span class="lineNum">     238 </span><span class="lineCov">          1 :   key = key.concat(key.slice(0, nBytes-16));  // key is now 16/24/32 bytes long</span>
<span class="lineNum">     239 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     240 </span><span class="lineCov">          1 :   var keySchedule = KeyExpansion(key);</span>
<span class="lineNum">     241 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     242 </span><span class="lineCov">          1 :   ciphertext = ciphertext.split('-');  // split ciphertext into array of block-length strings </span>
<span class="lineNum">     243 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     244 </span><span class="lineCov">          1 :   // recover nonce from 1st element of ciphertext</span>
<span class="lineNum">     245 </span><span class="lineCov">          1 :   var blockSize = 16;  // block size fixed at 16 bytes / 128 bits (Nb=4) for AES</span>
<span class="lineNum">     246 </span><span class="lineCov">          1 :   var counterBlock = new Array(blockSize);</span>
<span class="lineNum">     247 </span><span class="lineCov">          1 :   var ctrTxt = unescCtrlChars(ciphertext[0]);</span>
<span class="lineNum">     248 </span><span class="lineCov">          1 :   for (var i=0; i&lt;8; i++) counterBlock[i] = ctrTxt.charCodeAt(i);</span>
<span class="lineNum">     249 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     250 </span><span class="lineCov">          1 :   var plaintext = new Array(ciphertext.length-1);</span>
<span class="lineNum">     251 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     252 </span><span class="lineCov">          1 :   for (var b=1; b&lt;ciphertext.length; b++) {</span>
<span class="lineNum">     253 </span><span class="lineCov">          1 :     // set counter (block #) in last 8 bytes of counter block (leaving nonce in 1st 8 bytes)</span>
<span class="lineNum">     254 </span><span class="lineCov">          1 :     for (var c=0; c&lt;4; c++) counterBlock[15-c] = ((b-1) &gt;&gt;&gt; c*8) &amp; 0xff;</span>
<span class="lineNum">     255 </span><span class="lineCov">          1 :     for (var c=0; c&lt;4; c++) counterBlock[15-c-4] = ((b/0x100000000-1) &gt;&gt;&gt; c*8) &amp; 0xff;</span>
<span class="lineNum">     256 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     257 </span><span class="lineCov">          1 :     var cipherCntr = Cipher(counterBlock, keySchedule);  // encrypt counter block</span>
<span class="lineNum">     258 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     259 </span><span class="lineCov">          1 :     ciphertext[b] = unescCtrlChars(ciphertext[b]);</span>
<span class="lineNum">     260 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     261 </span><span class="lineCov">          1 :     var pt = '';</span>
<span class="lineNum">     262 </span><span class="lineCov">          1 :     for (var i=0; i&lt;ciphertext[b].length; i++) {</span>
<span class="lineNum">     263 </span><span class="lineCov">          1 :       // -- xor plaintext with ciphered counter byte-by-byte --</span>
<span class="lineNum">     264 </span><span class="lineCov">          1 :       var ciphertextByte = ciphertext[b].charCodeAt(i);</span>
<span class="lineNum">     265 </span><span class="lineCov">          1 :       var plaintextByte = ciphertextByte ^ cipherCntr[i];</span>
<span class="lineNum">     266 </span><span class="lineCov">          1 :       pt += String.fromCharCode(plaintextByte);</span>
<span class="lineNum">     267 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     268 </span><span class="lineCov">          1 :     // pt is now plaintext for this block</span>
<span class="lineNum">     269 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     270 </span><span class="lineCov">          1 :     plaintext[b-1] = pt;  // b-1 'cos no initial nonce block in plaintext</span>
<span class="lineNum">     271 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     272 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     273 </span><span class="lineCov">          1 :   return plaintext.join('');</span>
<span class="lineNum">     274 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     275 </span><span class="lineCov">          1 : </span>
<a name="276"><span class="lineNum">     276 </span><span class="lineCov">          1 : /* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span></a>
<a name="277"><span class="lineNum">     277 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">     278 </span><span class="lineCov">         85 : function escCtrlChars(str) {  // escape control chars which might cause problems handling ciphertext</span>
<span class="lineNum">     279 </span><span class="lineCov">         85 :   return str.replace(/[\0\t\n\v\f\r\xa0'&quot;!-]/g, function(c) { return '!' + c.charCodeAt(0) + '!'; });</span>
<a name="280"><span class="lineNum">     280 </span><span class="lineCov">         85 : }  // \xa0 to cater for bug in Firefox; include '-' to leave it free for use as a block marker</span></a>
<a name="281"><span class="lineNum">     281 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">     282 </span><span class="lineCov">         85 : function unescCtrlChars(str) {  // unescape potentially problematic control characters</span>
<span class="lineNum">     283 </span><span class="lineCov">         85 :   return str.replace(/!\d\d?\d?!/g, function(c) { return String.fromCharCode(c.slice(1,-1)); });</span>
<span class="lineNum">     284 </span><span class="lineCov">         85 : }</span>
<span class="lineNum">     285 </span><span class="lineCov">          1 : /* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span>
<span class="lineNum">     286 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     287 </span><span class="lineCov">          1 : /*</span>
<span class="lineNum">     288 </span><span class="lineCov">          1 :  * if escCtrlChars()/unescCtrlChars() still gives problems, use encodeBase64()/decodeBase64() instead</span>
<span class="lineNum">     289 </span><span class="lineCov">          1 :  */</span>
<a name="290"><span class="lineNum">     290 </span><span class="lineCov">          1 : var b64 = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;;</span></a>
<span class="lineNum">     291 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     292 </span><span class="lineCov">          1 : function encodeBase64(str) {  // http://tools.ietf.org/html/rfc4648</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :    var o1, o2, o3, h1, h2, h3, h4, bits, i=0, enc='';</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :    </span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :    str = encodeUTF8(str);  // encode multi-byte chars into UTF-8 for byte-array</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :    do {  // pack three octets into four hexets</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :       o1 = str.charCodeAt(i++);</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :       o2 = str.charCodeAt(i++);</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :       o3 = str.charCodeAt(i++);</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :       </span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :       bits = o1&lt;&lt;16 | o2&lt;&lt;8 | o3;</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :       </span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       h1 = bits&gt;&gt;18 &amp; 0x3f;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :       h2 = bits&gt;&gt;12 &amp; 0x3f;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :       h3 = bits&gt;&gt;6 &amp; 0x3f;</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       h4 = bits &amp; 0x3f;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       </span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :       // end of string? index to '=' in b64</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :       if (isNaN(o3)) h4 = 64;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :       if (isNaN(o2)) h3 = 64;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :       </span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :       // use hexets to index into b64, and append result to encoded string</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :       enc += b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :    } while (i &lt; str.length);</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :    </span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :    return enc;</span>
<a name="318"><span class="lineNum">     318 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     319 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     320 </span><span class="lineCov">          1 : function decodeBase64(str) {</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :    var o1, o2, o3, h1, h2, h3, h4, bits, i=0, enc='';</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :    do {  // unpack four hexets into three octets using index points in b64</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :       h1 = b64.indexOf(str.charAt(i++));</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :       h2 = b64.indexOf(str.charAt(i++));</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :       h3 = b64.indexOf(str.charAt(i++));</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :       h4 = b64.indexOf(str.charAt(i++));</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :       </span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       bits = h1&lt;&lt;18 | h2&lt;&lt;12 | h3&lt;&lt;6 | h4;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :       </span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :       o1 = bits&gt;&gt;16 &amp; 0xff;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :       o2 = bits&gt;&gt;8 &amp; 0xff;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :       o3 = bits &amp; 0xff;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :       </span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       if (h3 == 64)      enc += String.fromCharCode(o1);</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       else if (h4 == 64) enc += String.fromCharCode(o1, o2);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       else               enc += String.fromCharCode(o1, o2, o3);</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :    } while (i &lt; str.length);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 : </span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :    return decodeUTF8(enc);  // decode UTF-8 byte-array back to Unicode</span>
<a name="341"><span class="lineNum">     341 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     342 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     343 </span><span class="lineCov">          1 : function encodeUTF8(str) {  // encode multi-byte string into utf-8 multiple single-byte characters </span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :   str = str.replace(</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :       /[\u0080-\u07ff]/g,  // U+0080 - U+07FF = 2-byte chars</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :       function(c) { </span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :         var cc = c.charCodeAt(0);</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :         return String.fromCharCode(0xc0 | cc&gt;&gt;6, 0x80 | cc&amp;0x3f); }</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :     );</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :   str = str.replace(</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :       /[\u0800-\uffff]/g,  // U+0800 - U+FFFF = 3-byte chars</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :       function(c) { </span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :         var cc = c.charCodeAt(0); </span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :         return String.fromCharCode(0xe0 | cc&gt;&gt;12, 0x80 | cc&gt;&gt;6&amp;0x3F, 0x80 | cc&amp;0x3f); }</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     );</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   return str;</span>
<a name="357"><span class="lineNum">     357 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     358 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     359 </span><span class="lineCov">          1 : function decodeUTF8(str) {  // decode utf-8 encoded string back into multi-byte characters</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   str = str.replace(</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :       /[\u00c0-\u00df][\u0080-\u00bf]/g,                 // 2-byte chars</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :       function(c) { </span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :         var cc = (c.charCodeAt(0)&amp;0x1f)&lt;&lt;6 | c.charCodeAt(1)&amp;0x3f;</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         return String.fromCharCode(cc); }</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     );</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   str = str.replace(</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :       /[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,  // 3-byte chars</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :       function(c) { </span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :         var cc = (c.charCodeAt(0)&amp;0x0f)&lt;&lt;12 | (c.charCodeAt(1)&amp;0x3f&lt;&lt;6) | c.charCodeAt(2)&amp;0x3f; </span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :         return String.fromCharCode(cc); }</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :     );</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :   return str;</span>
<span class="lineNum">     373 </span><span class="lineCov">          1 : }</span>
<a name="374"><span class="lineNum">     374 </span><span class="lineCov">          1 : </span></a>
<span class="lineNum">     375 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     376 </span><span class="lineCov">          1 : function byteArrayToHexStr(b) {  // convert byte array to hex string for displaying test vectors</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :   var s = '';</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   for (var i=0; i&lt;b.length; i++) s += b[i].toString(16) + ' ';</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   return s;</span>
<span class="lineNum">     380 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     381 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     382 </span><span class="lineCov">          1 : /* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span>
<span class="lineNum">     383 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     384 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     385 </span><span class="lineCov">          1 : var plainText = &quot;ROMEO: But, soft! what light through yonder window breaks?\n\</span>
<span class="lineNum">     386 </span><span class="lineCov">          1 : It is the east, and Juliet is the sun.\n\</span>
<span class="lineNum">     387 </span><span class="lineCov">          1 : Arise, fair sun, and kill the envious moon,\n\</span>
<span class="lineNum">     388 </span><span class="lineCov">          1 : Who is already sick and pale with grief,\n\</span>
<span class="lineNum">     389 </span><span class="lineCov">          1 : That thou her maid art far more fair than she:\n\</span>
<span class="lineNum">     390 </span><span class="lineCov">          1 : Be not her maid, since she is envious;\n\</span>
<span class="lineNum">     391 </span><span class="lineCov">          1 : Her vestal livery is but sick and green\n\</span>
<span class="lineNum">     392 </span><span class="lineCov">          1 : And none but fools do wear it; cast it off.\n\</span>
<span class="lineNum">     393 </span><span class="lineCov">          1 : It is my lady, O, it is my love!\n\</span>
<span class="lineNum">     394 </span><span class="lineCov">          1 : O, that she knew she were!\n\</span>
<span class="lineNum">     395 </span><span class="lineCov">          1 : She speaks yet she says nothing: what of that?\n\</span>
<span class="lineNum">     396 </span><span class="lineCov">          1 : Her eye discourses; I will answer it.\n\</span>
<span class="lineNum">     397 </span><span class="lineCov">          1 : I am too bold, 'tis not to me she speaks:\n\</span>
<span class="lineNum">     398 </span><span class="lineCov">          1 : Two of the fairest stars in all the heaven,\n\</span>
<span class="lineNum">     399 </span><span class="lineCov">          1 : Having some business, do entreat her eyes\n\</span>
<span class="lineNum">     400 </span><span class="lineCov">          1 : To twinkle in their spheres till they return.\n\</span>
<span class="lineNum">     401 </span><span class="lineCov">          1 : What if her eyes were there, they in her head?\n\</span>
<span class="lineNum">     402 </span><span class="lineCov">          1 : The brightness of her cheek would shame those stars,\n\</span>
<span class="lineNum">     403 </span><span class="lineCov">          1 : As daylight doth a lamp; her eyes in heaven\n\</span>
<span class="lineNum">     404 </span><span class="lineCov">          1 : Would through the airy region stream so bright\n\</span>
<span class="lineNum">     405 </span><span class="lineCov">          1 : That birds would sing and think it were not night.\n\</span>
<span class="lineNum">     406 </span><span class="lineCov">          1 : See, how she leans her cheek upon her hand!\n\</span>
<span class="lineNum">     407 </span><span class="lineCov">          1 : O, that I were a glove upon that hand,\n\</span>
<span class="lineNum">     408 </span><span class="lineCov">          1 : That I might touch that cheek!\n\</span>
<span class="lineNum">     409 </span><span class="lineCov">          1 : JULIET: Ay me!\n\</span>
<span class="lineNum">     410 </span><span class="lineCov">          1 : ROMEO: She speaks:\n\</span>
<span class="lineNum">     411 </span><span class="lineCov">          1 : O, speak again, bright angel! for thou art\n\</span>
<span class="lineNum">     412 </span><span class="lineCov">          1 : As glorious to this night, being o'er my head\n\</span>
<span class="lineNum">     413 </span><span class="lineCov">          1 : As is a winged messenger of heaven\n\</span>
<span class="lineNum">     414 </span><span class="lineCov">          1 : Unto the white-upturned wondering eyes\n\</span>
<span class="lineNum">     415 </span><span class="lineCov">          1 : Of mortals that fall back to gaze on him\n\</span>
<span class="lineNum">     416 </span><span class="lineCov">          1 : When he bestrides the lazy-pacing clouds\n\</span>
<span class="lineNum">     417 </span><span class="lineCov">          1 : And sails upon the bosom of the air.&quot;;</span>
<span class="lineNum">     418 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     419 </span><span class="lineCov">          1 : var password = &quot;O Romeo, Romeo! wherefore art thou Romeo?&quot;;</span>
<span class="lineNum">     420 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     421 </span><span class="lineCov">          1 : var cipherText = AESEncryptCtr(plainText, password, 256);</span>
<span class="lineNum">     422 </span><span class="lineCov">          1 : var decryptedText = AESDecryptCtr(cipherText, password, 256);</span>
<span class="lineNum">     423 </span><span class="lineCov">          1 : </span>
<span class="lineNum">     424 </span><span class="lineCov">          1 : if (decryptedText != plainText)</span>
<span class="lineNum">     425 </span><span class="lineCov">          1 :     throw &quot;ERROR: bad result: expected &quot; + plainText + &quot; but got &quot; + decryptedText;</span>
<span class="lineNum">     426 </span><span class="lineCov">          1 : </span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
